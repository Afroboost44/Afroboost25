import { NextResponse } from 'next/server';

// Replace with your hardcoded Sandbox credentials
const clientId = "Ac60l0ObtQDg7tqEdDC6A5nppNgLd0cEiJxI9Fzflo7uwCyf54ozKW7XMi0VFiB8xjD52qgkNzHvkxCD";
const clientSecret = "EN6Hi5eK15u3el1oMZkLLSjr6GyUUkziuTWQNV5KdEKwZha5wz7G7E8nGrlnx9lRnSs5rjBWE5atf4iS";
const isProduction = false;

const baseUrl = isProduction ? 'https://api.paypal.com' : 'https://api.sandbox.paypal.com';

// Fetch PayPal access token
async function getPayPalAccessToken() {
  const base64Auth = Buffer.from(`${clientId.trim()}:${clientSecret.trim()}`).toString('base64');

  const response = await fetch(`${baseUrl}/v1/oauth2/token`, {
    method: 'POST',
    headers: {
      Authorization: `Basic ${base64Auth}`,
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: 'grant_type=client_credentials',
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`PayPal token error ${response.status}: ${errorText}`);
  }

  const data = await response.json();
  return data.access_token;
}

// Create PayPal order
async function createPayPalOrder(amount: number, description: string) {
  const accessToken = await getPayPalAccessToken();

  const orderData = {
    intent: 'CAPTURE',
    purchase_units: [
      {
        amount: {
          currency_code: 'USD',
          value: amount.toFixed(2),
        },
        description,
      },
    ],
    application_context: {
      return_url: `${process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'}/payment/success`,
      cancel_url: `${process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'}/payment/cancel`,
      shipping_preference: 'NO_SHIPPING',
      user_action: 'PAY_NOW',
      brand_name: 'AfroBoost Dance Platform',
    },
  };

  const response = await fetch(`${baseUrl}/v2/checkout/orders`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${accessToken}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=representation',
      'PayPal-Request-Id': `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
    },
    body: JSON.stringify(orderData),
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`PayPal order creation failed ${response.status}: ${errorText}`);
  }

  const data = await response.json();
  return data;
}

// API handler
export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { amount, description } = body;

    if (!amount || isNaN(amount) || amount <= 0) {
      return NextResponse.json({ error: 'Invalid amount' }, { status: 400 });
    }

    const order = await createPayPalOrder(parseFloat(amount), description || 'Payment for services');

    return NextResponse.json({
      id: order.id,
      status: order.status,
      links: order.links,
      ...order,
    });
  } catch (error: any) {
    return NextResponse.json({
      error: error.message || 'Unexpected error',
    }, { status: 500 });
  }
}
